(function(){var a={};tinymce.create("tinymce.plugins.wpEditImage",{url:"",editor:{},init:function(b,c){var d=this;d.url=c;d.editor=b;d._createButtons();b.addCommand("WP_EditImage",d._editImage);b.onInit.add(function(e){e.dom.events.add(e.getBody(),"mousedown",function(g){var f;if(g.target.nodeName=="IMG"&&(f=e.dom.getParent(g.target,"div.mceTemp"))){if(tinymce.isGecko){e.selection.select(f)}else{if(tinymce.isWebKit){e.dom.events.prevent(g)}}}});e.dom.events.add(e.getBody(),"keydown",function(i){var j,f,h,g;if(i.keyCode==13){j=e.selection.getNode();f=e.dom.getParent(j,"dl.wp-caption");if(f){h=e.dom.getParent(f,"div.mceTemp")}if(h){e.dom.events.cancel(i);g=e.dom.create("p",{},"\uFEFF");e.dom.insertAfter(g,h);e.selection.setCursorLocation(g,0);return false}}});if("ontouchstart" in window){e.dom.events.add(e.getBody(),"touchstart",function(f){d._showButtons(f)})}});b.onMouseUp.add(function(f,g){if(tinymce.isWebKit||tinymce.isOpera){return}if(a.x&&(g.clientX!=a.x||g.clientY!=a.y)){var h=f.selection.getNode();if("IMG"==h.nodeName){window.setTimeout(function(){var e=f.dom.getParent(h,"dl.wp-caption"),i;if(h.width!=a.img_w||h.height!=a.img_h){h.className=h.className.replace(/size-[^ "']+/,"")}if(e){i=f.dom.getAttrib(h,"width")||h.width;i=parseInt(i,10);f.dom.setStyle(e,"width",10+i);f.execCommand("mceRepaint")}},100)}}a={}});b.onMouseDown.add(function(f,g){d._showButtons(g)});b.onBeforeSetContent.add(function(e,f){f.content=e.wpSetImgCaption(f.content)});b.onPostProcess.add(function(e,f){if(f.get){f.content=e.wpGetImgCaption(f.content)}});b.wpSetImgCaption=function(e){return d._do_shcode(e)};b.wpGetImgCaption=function(e){return d._get_shcode(e)};b.onBeforeExecCommand.add(function(e,g){var f,h;if(g=="mceInsertContent"){f=e.dom.getParent(e.selection.getNode(),"div.mceTemp");if(!f){return}h=e.dom.create("p");e.dom.insertAfter(h,f);e.selection.setCursorLocation(h,0)}})},_do_shcode:function(b){return b.replace(/(?:<p>)?\[(?:wp_)?caption([^\]]+)\]([\s\S]+?)\[\/(?:wp_)?caption\](?:<\/p>)?/g,function(j,i,h){var d,m,k,l,f,g,e=tinymce.trim;d=i.match(/id=['"]([^'"]*)['"] ?/);if(d){i=i.replace(d[0],"")}m=i.match(/align=['"]([^'"]*)['"] ?/);if(m){i=i.replace(m[0],"")}k=i.match(/width=['"]([0-9]*)['"] ?/);if(k){i=i.replace(k[0],"")}h=e(h);g=h.match(/((?:<a [^>]+>)?<img [^>]+>(?:<\/a>)?)([\s\S]*)/i);if(g&&g[2]){l=e(g[2]);g=e(g[1])}else{l=e(i).replace(/caption=['"]/,"").replace(/['"]$/,"");g=h}d=(d&&d[1])?d[1]:"";m=(m&&m[1])?m[1]:"alignnone";k=(k&&k[1])?k[1]:"";if(!k||!l){return h}f="mceTemp";if(m=="aligncenter"){f+=" mceIEcenter"}k=parseInt(k,10)+10;return'<div class="'+f+'"><dl id="'+d+'" class="wp-caption '+m+'" style="width: '+k+'px"><dt class="wp-caption-dt">'+g+'</dt><dd class="wp-caption-dd">'+l+"</dd></dl></div>"})},_get_shcode:function(b){return b.replace(/<div (?:id="attachment_|class="mceTemp)[^>]*>([\s\S]+?)<\/div>/g,function(d,c){var e=c.replace(/<dl ([^>]+)>\s*<dt [^>]+>([\s\S]+?)<\/dt>\s*<dd [^>]+>([\s\S]*?)<\/dd>\s*<\/dl>/gi,function(i,f,l,j){var k,h,g;g=l.match(/width="([0-9]*)"/);g=(g&&g[1])?g[1]:"";if(!g||!j){return l}k=f.match(/id="([^"]*)"/);k=(k&&k[1])?k[1]:"";h=f.match(/class="([^"]*)"/);h=(h&&h[1])?h[1]:"";h=h.match(/align[a-z]+/)||"alignnone";j=j.replace(/\r\n|\r/g,"\n").replace(/<[a-zA-Z0-9]+( [^<>]+)?>/g,function(m){return m.replace(/[\r\n\t]+/," ")});j=j.replace(/\s*\n\s*/g,"<br />");return'[caption id="'+k+'" align="'+h+'" width="'+g+'"]'+l+" "+j+"[/caption]"});if(e.indexOf("[caption")!==0){e=c.replace(/[\s\S]*?((?:<a [^>]+>)?<img [^>]+>(?:<\/a>)?)(<p>[\s\S]*<\/p>)?[\s\S]*/gi,"<p>$1</p>$2")}return e})},_createButtons:function(){var c=this,b=tinymce.activeEditor,e=tinymce.DOM,f,d,g;if(e.get("wp_editbtns")){return}g=(window.devicePixelRatio&&window.devicePixelRatio>1)||(window.matchMedia&&window.matchMedia("(min-resolution:130dpi)").matches);e.add(document.body,"div",{id:"wp_editbtns",style:"display:none;"});f=e.add("wp_editbtns","img",{src:g?c.url+"/img/image-2x.png":c.url+"/img/image.png",id:"wp_editimgbtn",width:"24",height:"24",title:b.getLang("wpeditimage.edit_img")});tinymce.dom.Event.add(f,"mousedown",function(){c._editImage();b.plugins.wordpress._hideButtons()});d=e.add("wp_editbtns","img",{src:g?c.url+"/img/delete-2x.png":c.url+"/img/delete.png",id:"wp_delimgbtn",width:"24",height:"24",title:b.getLang("wpeditimage.del_img")});tinymce.dom.Event.add(d,"mousedown",function(){var h=tinymce.activeEditor,j=h.selection.getNode(),i;if(j.nodeName=="IMG"&&h.dom.getAttrib(j,"class").indexOf("mceItem")==-1){if((i=h.dom.getParent(j,"div"))&&h.dom.hasClass(i,"mceTemp")){h.dom.remove(i)}else{if(j.parentNode.nodeName=="A"&&j.parentNode.childNodes.length==1){j=j.parentNode}if(j.parentNode.nodeName=="P"&&j.parentNode.childNodes.length==1){j=j.parentNode}h.dom.remove(j)}h.execCommand("mceRepaint");return false}h.plugins.wordpress._hideButtons()})},_editImage:function(){var e=tinymce.activeEditor,f=this.url,h=e.selection.getNode(),d,g,b,c=h.className;if(c.indexOf("mceItem")!=-1||c.indexOf("wpGallery")!=-1||h.nodeName!="IMG"){return}d=tinymce.DOM.getViewPort();g=680<(d.h-70)?680:d.h-70;b=650<d.w?650:d.w;e.windowManager.open({file:f+"/editimage.html",width:b+"px",height:g+"px",inline:true})},_showButtons:function(d){var b=this.editor,c=d.target;if(c.nodeName!="IMG"){if(c.firstChild&&c.firstChild.nodeName=="IMG"&&c.childNodes.length==1){c=c.firstChild}else{b.plugins.wordpress._hideButtons();return}}if(b.dom.getAttrib(c,"class").indexOf("mceItem")==-1){a={x:d.clientX,y:d.clientY,img_w:c.clientWidth,img_h:c.clientHeight};if(d.type=="touchstart"){b.selection.select(c);b.dom.events.cancel(d)}b.plugins.wordpress._hideButtons();b.plugins.wordpress._showButtons(c,"wp_editbtns")}},getInfo:function(){return{longname:"Edit Image",author:"WordPress",authorurl:"http://wordpress.org",infourl:"",version:"1.0"}}});tinymce.PluginManager.add("wpeditimage",tinymce.plugins.wpEditImage)})();