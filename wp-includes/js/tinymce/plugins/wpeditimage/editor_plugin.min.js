!function(){tinymce.create("tinymce.plugins.wpEditImage",{url:"",editor:{},init:function(f,e){var h=this,g={};h.url=e,h.editor=f,h._createButtons(),f.addCommand("WP_EditImage",h._editImage),f.onInit.add(function(b){b.dom.events.add(b.getBody(),"mousedown",function(a){var d;"IMG"==a.target.nodeName&&(d=b.dom.getParent(a.target,"div.mceTemp"))&&(tinymce.isGecko?b.selection.select(d):tinymce.isWebKit&&b.dom.events.prevent(a))}),b.dom.events.add(b.getBody(),"keydown",function(a){var l,k,j,i;return 13==a.keyCode&&(l=b.selection.getNode(),k=b.dom.getParent(l,"dl.wp-caption"),k&&(j=b.dom.getParent(k,"div.mceTemp")),j)?(b.dom.events.cancel(a),i=b.dom.create("p",{},""),b.dom.insertAfter(i,j),b.selection.setCursorLocation(i,0),!1):void 0}),"ontouchstart" in window&&b.dom.events.add(b.getBody(),"touchstart",function(c){h._showButtons(c)})}),f.onMouseUp.add(function(i,d){if(!tinymce.isWebKit&&!tinymce.isOpera){if(g.x&&(d.clientX!=g.x||d.clientY!=g.y)){var j=i.selection.getNode();"IMG"==j.nodeName&&window.setTimeout(function(){var a,c=i.dom.getParent(j,"dl.wp-caption");(j.width!=g.img_w||j.height!=g.img_h)&&(j.className=j.className.replace(/size-[^ "']+/,"")),c&&(a=i.dom.getAttrib(j,"width")||j.width,a=parseInt(a,10),i.dom.setStyle(c,"width",10+a),i.execCommand("mceRepaint"))},100)}g={}}}),f.onMouseDown.add(function(d,c){h._showButtons(c)}),f.onBeforeSetContent.add(function(d,c){c.content=d.wpSetImgCaption(c.content)}),f.onPostProcess.add(function(d,c){c.get&&(c.content=d.wpGetImgCaption(c.content))}),f.wpSetImgCaption=function(b){return h._do_shcode(b)},f.wpGetImgCaption=function(b){return h._get_shcode(b)},f.onBeforeExecCommand.add(function(j,i){var l,k;if("mceInsertContent"==i){if(l=j.dom.getParent(j.selection.getNode(),"div.mceTemp"),!l){return}k=j.dom.create("p"),j.dom.insertAfter(k,l),j.selection.setCursorLocation(k,0)}})},_do_shcode:function(b){return b.replace(/(?:<p>)?\[(?:wp_)?caption([^\]]+)\]([\s\S]+?)\[\/(?:wp_)?caption\](?:<\/p>)?/g,function(t,s,r){var q,p,o,n,m,l,k=tinymce.trim;return q=s.match(/id=['"]([^'"]*)['"] ?/),q&&(s=s.replace(q[0],"")),p=s.match(/align=['"]([^'"]*)['"] ?/),p&&(s=s.replace(p[0],"")),o=s.match(/width=['"]([0-9]*)['"] ?/),o&&(s=s.replace(o[0],"")),r=k(r),l=r.match(/((?:<a [^>]+>)?<img [^>]+>(?:<\/a>)?)([\s\S]*)/i),l&&l[2]?(n=k(l[2]),l=k(l[1])):(n=k(s).replace(/caption=['"]/,"").replace(/['"]$/,""),l=r),q=q&&q[1]?q[1]:"",p=p&&p[1]?p[1]:"alignnone",o=o&&o[1]?o[1]:"",o&&n?(m="mceTemp","aligncenter"==p&&(m+=" mceIEcenter"),o=parseInt(o,10)+10,'<div class="'+m+'"><dl id="'+q+'" class="wp-caption '+p+'" style="width: '+o+'px"><dt class="wp-caption-dt">'+l+'</dt><dd class="wp-caption-dd">'+n+"</dd></dl></div>"):r})},_get_shcode:function(b){return b.replace(/<div (?:id="attachment_|class="mceTemp)[^>]*>([\s\S]+?)<\/div>/g,function(e,d){var f=d.replace(/<dl ([^>]+)>\s*<dt [^>]+>([\s\S]+?)<\/dt>\s*<dd [^>]+>([\s\S]*?)<\/dd>\s*<\/dl>/gi,function(i,h,n,m){var l,k,j;return j=n.match(/width="([0-9]*)"/),j=j&&j[1]?j[1]:"",j&&m?(l=h.match(/id="([^"]*)"/),l=l&&l[1]?l[1]:"",k=h.match(/class="([^"]*)"/),k=k&&k[1]?k[1]:"",k=k.match(/align[a-z]+/)||"alignnone",m=m.replace(/\r\n|\r/g,"\n").replace(/<[a-zA-Z0-9]+( [^<>]+)?>/g,function(c){return c.replace(/[\r\n\t]+/," ")}),m=m.replace(/\s*\n\s*/g,"<br />"),'[caption id="'+l+'" align="'+k+'" width="'+j+'"]'+n+" "+m+"[/caption]"):n});return 0!==f.indexOf("[caption")&&(f=d.replace(/[\s\S]*?((?:<a [^>]+>)?<img [^>]+>(?:<\/a>)?)(<p>[\s\S]*<\/p>)?[\s\S]*/gi,"<p>$1</p>$2")),f})},_createButtons:function(){var h,g,l,k=this,j=tinymce.activeEditor,i=tinymce.DOM;i.get("wp_editbtns")||(l=window.devicePixelRatio&&window.devicePixelRatio>1||window.matchMedia&&window.matchMedia("(min-resolution:130dpi)").matches,i.add(document.body,"div",{id:"wp_editbtns",style:"display:none;"}),h=i.add("wp_editbtns","img",{src:l?k.url+"/img/image-2x.png":k.url+"/img/image.png",id:"wp_editimgbtn",width:"24",height:"24",title:j.getLang("wpeditimage.edit_img")}),tinymce.dom.Event.add(h,"mousedown",function(){k._editImage(),j.plugins.wordpress._hideButtons()}),g=i.add("wp_editbtns","img",{src:l?k.url+"/img/delete-2x.png":k.url+"/img/delete.png",id:"wp_delimgbtn",width:"24",height:"24",title:j.getLang("wpeditimage.del_img")}),tinymce.dom.Event.add(g,"mousedown",function(){var e,d=tinymce.activeEditor,f=d.selection.getNode();return"IMG"==f.nodeName&&-1==d.dom.getAttrib(f,"class").indexOf("mceItem")?((e=d.dom.getParent(f,"div"))&&d.dom.hasClass(e,"mceTemp")?d.dom.remove(e):("A"==f.parentNode.nodeName&&1==f.parentNode.childNodes.length&&(f=f.parentNode),"P"==f.parentNode.nodeName&&1==f.parentNode.childNodes.length&&(f=f.parentNode),d.dom.remove(f)),d.execCommand("mceRepaint"),!1):(d.plugins.wordpress._hideButtons(),void 0)}))},_editImage:function(){var i,h,n,m=tinymce.activeEditor,l=this.url,k=m.selection.getNode(),j=k.className;-1==j.indexOf("mceItem")&&-1==j.indexOf("wpGallery")&&"IMG"==k.nodeName&&(i=tinymce.DOM.getViewPort(),h=680<i.h-70?680:i.h-70,n=650<i.w?650:i.w,m.windowManager.open({file:l+"/editimage.html",width:n+"px",height:h+"px",inline:!0}))},_showButtons:function(e){var d=this.editor,f=e.target;if("IMG"!=f.nodeName){if(!f.firstChild||"IMG"!=f.firstChild.nodeName||1!=f.childNodes.length){return d.plugins.wordpress._hideButtons(),void 0}f=f.firstChild}-1==d.dom.getAttrib(f,"class").indexOf("mceItem")&&(mouse={x:e.clientX,y:e.clientY,img_w:f.clientWidth,img_h:f.clientHeight},"touchstart"==e.type&&(d.selection.select(f),d.dom.events.cancel(e)),d.plugins.wordpress._hideButtons(),d.plugins.wordpress._showButtons(f,"wp_editbtns"))},getInfo:function(){return{longname:"Edit Image",author:"WordPress",authorurl:"http://wordpress.org",infourl:"",version:"1.0"}}}),tinymce.PluginManager.add("wpeditimage",tinymce.plugins.wpEditImage)}();