!function(){tinymce.create("tinymce.plugins.wpGallery",{init:function(e,d){var f=this;f.url=d,f.editor=e,f._createButtons(),e.addCommand("WP_Gallery",function(){tinymce.isIE&&e.selection.moveToBookmark(e.wpGalleryBookmark);var a,h=e.selection.getNode(),g=wp.media.gallery;"undefined"!=typeof wp&&wp.media&&wp.media.gallery&&"IMG"==h.nodeName&&-1!=e.dom.getAttrib(h,"class").indexOf("wp-gallery")&&(a=g.edit("["+e.dom.getAttrib(h,"title")+"]"),a.state("gallery-edit").on("update",function(c){var i=g.shortcode(c).string().slice(1,-1);e.dom.setAttrib(h,"title",i)}))}),e.onInit.add(function(b){"ontouchstart" in window&&b.dom.events.add(b.getBody(),"touchstart",function(a){var g=a.target;"IMG"==g.nodeName&&b.dom.hasClass(g,"wp-gallery")&&(b.selection.select(g),b.dom.events.cancel(a),b.plugins.wordpress._hideButtons(),b.plugins.wordpress._showButtons(g,"wp_gallerybtns"))})}),e.onMouseDown.add(function(g,c){"IMG"==c.target.nodeName&&g.dom.hasClass(c.target,"wp-gallery")&&(g.plugins.wordpress._hideButtons(),g.plugins.wordpress._showButtons(c.target,"wp_gallerybtns"))}),e.onBeforeSetContent.add(function(g,c){c.content=f._do_gallery(c.content)}),e.onPostProcess.add(function(g,c){c.get&&(c.content=f._get_gallery(c.content))})},_do_gallery:function(b){return b.replace(/\[gallery([^\]]*)\]/g,function(d,c){return'<img src="'+tinymce.baseURL+'/plugins/wpgallery/img/t.gif" class="wp-gallery mceItem" title="gallery'+tinymce.DOM.encode(c)+'" />'})},_get_gallery:function(d){function c(f,e){return e=new RegExp(e+'="([^"]+)"',"g").exec(f),e?tinymce.DOM.decode(e[1]):""}return d.replace(/(?:<p[^>]*>)*(<img[^>]+>)(?:<\/p>)*/g,function(b,f){var e=c(f,"class");return -1!=e.indexOf("wp-gallery")?"<p>["+tinymce.trim(c(f,"title"))+"]</p>":b})},_createButtons:function(){var h,g,l,k=this,j=tinymce.activeEditor,i=tinymce.DOM;i.get("wp_gallerybtns")||(l=window.devicePixelRatio&&window.devicePixelRatio>1||window.matchMedia&&window.matchMedia("(min-resolution:130dpi)").matches,i.add(document.body,"div",{id:"wp_gallerybtns",style:"display:none;"}),h=i.add("wp_gallerybtns","img",{src:l?k.url+"/img/edit-2x.png":k.url+"/img/edit.png",id:"wp_editgallery",width:"24",height:"24",title:j.getLang("wordpress.editgallery")}),tinymce.dom.Event.add(h,"mousedown",function(){var b=tinymce.activeEditor;b.wpGalleryBookmark=b.selection.getBookmark("simple"),b.execCommand("WP_Gallery"),b.plugins.wordpress._hideButtons()}),g=i.add("wp_gallerybtns","img",{src:l?k.url+"/img/delete-2x.png":k.url+"/img/delete.png",id:"wp_delgallery",width:"24",height:"24",title:j.getLang("wordpress.delgallery")}),tinymce.dom.Event.add(g,"mousedown",function(e){var d=tinymce.activeEditor,f=d.selection.getNode();"IMG"==f.nodeName&&d.dom.hasClass(f,"wp-gallery")&&(d.dom.remove(f),d.execCommand("mceRepaint"),d.dom.events.cancel(e)),d.plugins.wordpress._hideButtons()}))},getInfo:function(){return{longname:"Gallery Settings",author:"WordPress",authorurl:"http://wordpress.org",infourl:"",version:"1.0"}}}),tinymce.PluginManager.add("wpgallery",tinymce.plugins.wpGallery)}();