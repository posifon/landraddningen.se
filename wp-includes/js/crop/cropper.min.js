var CropDraggable=Class.create();Object.extend(Object.extend(CropDraggable.prototype,Draggable.prototype),{initialize:function(a){this.options=Object.extend({drawMethod:function(){}},arguments[1]||{});this.element=$(a);this.handle=this.element;this.delta=this.currentDelta();this.dragging=false;this.eventMouseDown=this.initDrag.bindAsEventListener(this);Event.observe(this.handle,"mousedown",this.eventMouseDown);Draggables.register(this)},draw:function(b){var a=Position.cumulativeOffset(this.element);var e=this.currentDelta();a[0]-=e[0];a[1]-=e[1];var c=[0,1].map(function(d){return(b[d]-a[d]-this.offset[d])}.bind(this));this.options.drawMethod(c)}});var Cropper={};Cropper.Img=Class.create();Cropper.Img.prototype={initialize:function(c,a){this.options=Object.extend({ratioDim:{x:0,y:0},minWidth:0,minHeight:0,displayOnInit:false,onEndCrop:Prototype.emptyFunction,captureKeys:true},a||{});if(this.options.minWidth>0&&this.options.minHeight>0){this.options.ratioDim.x=this.options.minWidth;this.options.ratioDim.y=this.options.minHeight}this.img=$(c);this.clickCoords={x:0,y:0};this.dragging=false;this.resizing=false;this.isWebKit=/Konqueror|Safari|KHTML/.test(navigator.userAgent);this.isIE=/MSIE/.test(navigator.userAgent);this.isOpera8=/Opera\s[1-8]/.test(navigator.userAgent);this.ratioX=0;this.ratioY=0;this.attached=false;$A(document.getElementsByTagName("script")).each(function(f){if(f.src.match(/cropper\.js/)){var e=f.src.replace(/cropper\.js(.*)?/,"");var d=document.createElement("link");d.rel="stylesheet";d.type="text/css";d.href=e+"cropper.css";d.media="screen";document.getElementsByTagName("head")[0].appendChild(d)}});if(this.options.ratioDim.x>0&&this.options.ratioDim.y>0){var b=this.getGCD(this.options.ratioDim.x,this.options.ratioDim.y);this.ratioX=this.options.ratioDim.x/b;this.ratioY=this.options.ratioDim.y/b}this.subInitialize();if(this.img.complete||this.isWebKit){this.onLoad()}else{Event.observe(this.img,"load",this.onLoad.bindAsEventListener(this))}},getGCD:function(d,c){return 1;if(c==0){return d}return this.getGCD(c,d%c)},onLoad:function(){var f="imgCrop_";var e=this.img.parentNode;var d="";if(this.isOpera8){d=" opera8"}this.imgWrap=Builder.node("div",{"class":f+"wrap"+d});if(this.isIE){this.north=Builder.node("div",{"class":f+"overlay "+f+"north"},[Builder.node("span")]);this.east=Builder.node("div",{"class":f+"overlay "+f+"east"},[Builder.node("span")]);this.south=Builder.node("div",{"class":f+"overlay "+f+"south"},[Builder.node("span")]);this.west=Builder.node("div",{"class":f+"overlay "+f+"west"},[Builder.node("span")]);var c=[this.north,this.east,this.south,this.west]}else{this.overlay=Builder.node("div",{"class":f+"overlay"});var c=[this.overlay]}this.dragArea=Builder.node("div",{"class":f+"dragArea"},c);this.handleN=Builder.node("div",{"class":f+"handle "+f+"handleN"});this.handleNE=Builder.node("div",{"class":f+"handle "+f+"handleNE"});this.handleE=Builder.node("div",{"class":f+"handle "+f+"handleE"});this.handleSE=Builder.node("div",{"class":f+"handle "+f+"handleSE"});this.handleS=Builder.node("div",{"class":f+"handle "+f+"handleS"});this.handleSW=Builder.node("div",{"class":f+"handle "+f+"handleSW"});this.handleW=Builder.node("div",{"class":f+"handle "+f+"handleW"});this.handleNW=Builder.node("div",{"class":f+"handle "+f+"handleNW"});this.selArea=Builder.node("div",{"class":f+"selArea"},[Builder.node("div",{"class":f+"marqueeHoriz "+f+"marqueeNorth"},[Builder.node("span")]),Builder.node("div",{"class":f+"marqueeVert "+f+"marqueeEast"},[Builder.node("span")]),Builder.node("div",{"class":f+"marqueeHoriz "+f+"marqueeSouth"},[Builder.node("span")]),Builder.node("div",{"class":f+"marqueeVert "+f+"marqueeWest"},[Builder.node("span")]),this.handleN,this.handleNE,this.handleE,this.handleSE,this.handleS,this.handleSW,this.handleW,this.handleNW,Builder.node("div",{"class":f+"clickArea"})]);Element.setStyle($(this.selArea),{backgroundColor:"transparent",backgroundRepeat:"no-repeat",backgroundPosition:"0 0"});this.imgWrap.appendChild(this.img);this.imgWrap.appendChild(this.dragArea);this.dragArea.appendChild(this.selArea);this.dragArea.appendChild(Builder.node("div",{"class":f+"clickArea"}));e.appendChild(this.imgWrap);Event.observe(this.dragArea,"mousedown",this.startDrag.bindAsEventListener(this));Event.observe(document,"mousemove",this.onDrag.bindAsEventListener(this));Event.observe(document,"mouseup",this.endCrop.bindAsEventListener(this));var b=[this.handleN,this.handleNE,this.handleE,this.handleSE,this.handleS,this.handleSW,this.handleW,this.handleNW];for(var a=0;a<b.length;a++){Event.observe(b[a],"mousedown",this.startResize.bindAsEventListener(this))}if(this.options.captureKeys){Event.observe(document,"keydown",this.handleKeys.bindAsEventListener(this))}new CropDraggable(this.selArea,{drawMethod:this.moveArea.bindAsEventListener(this)});this.setParams()},setParams:function(){this.imgW=this.img.width;this.imgH=this.img.height;if(!this.isIE){Element.setStyle($(this.overlay),{width:this.imgW+"px",height:this.imgH+"px"});Element.hide($(this.overlay));Element.setStyle($(this.selArea),{backgroundImage:"url("+this.img.src+")"})}else{Element.setStyle($(this.north),{height:0});Element.setStyle($(this.east),{width:0,height:0});Element.setStyle($(this.south),{height:0});Element.setStyle($(this.west),{width:0,height:0})}Element.setStyle($(this.imgWrap),{width:this.imgW+"px",height:this.imgH+"px"});Element.hide($(this.selArea));var b=Position.positionedOffset(this.imgWrap);this.wrapOffsets={top:b[1],left:b[0]};var a={x1:0,y1:0,x2:0,y2:0};this.setAreaCoords(a);if(this.options.ratioDim.x>0&&this.options.ratioDim.y>0&&this.options.displayOnInit){a.x1=Math.ceil((this.imgW-this.options.ratioDim.x)/2);a.y1=Math.ceil((this.imgH-this.options.ratioDim.y)/2);a.x2=a.x1+this.options.ratioDim.x;a.y2=a.y1+this.options.ratioDim.y;Element.show(this.selArea);this.drawArea();this.endCrop()}this.attached=true},remove:function(){this.attached=false;this.imgWrap.parentNode.insertBefore(this.img,this.imgWrap);this.imgWrap.parentNode.removeChild(this.imgWrap);Event.stopObserving(this.dragArea,"mousedown",this.startDrag.bindAsEventListener(this));Event.stopObserving(document,"mousemove",this.onDrag.bindAsEventListener(this));Event.stopObserving(document,"mouseup",this.endCrop.bindAsEventListener(this));var a=[this.handleN,this.handleNE,this.handleE,this.handleSE,this.handleS,this.handleSW,this.handleW,this.handleNW];for(var b=0;b<a.length;b++){Event.stopObserving(a[b],"mousedown",this.startResize.bindAsEventListener(this))}if(this.options.captureKeys){Event.stopObserving(document,"keydown",this.handleKeys.bindAsEventListener(this))}},reset:function(){if(!this.attached){this.onLoad()}else{this.setParams()}this.endCrop()},handleKeys:function(b){var a={x:0,y:0};if(!this.dragging){switch(b.keyCode){case (37):a.x=-1;break;case (38):a.y=-1;break;case (39):a.x=1;break;case (40):a.y=1;break}if(a.x!=0||a.y!=0){if(b.shiftKey){a.x*=10;a.y*=10}this.moveArea([this.areaCoords.x1+a.x,this.areaCoords.y1+a.y]);Event.stop(b)}}},calcW:function(){return(this.areaCoords.x2-this.areaCoords.x1)},calcH:function(){return(this.areaCoords.y2-this.areaCoords.y1)},moveArea:function(a){this.setAreaCoords({x1:a[0],y1:a[1],x2:a[0]+this.calcW(),y2:a[1]+this.calcH()},true);this.drawArea()},cloneCoords:function(a){return{x1:a.x1,y1:a.y1,x2:a.x2,y2:a.y2}},setAreaCoords:function(g,f,e,d,c){var b=typeof f!="undefined"?f:false;var a=typeof e!="undefined"?e:false;if(f){var m=g.x2-g.x1;var l=g.y2-g.y1;if(g.x1<0){g.x1=0;g.x2=m}if(g.y1<0){g.y1=0;g.y2=l}if(g.x2>this.imgW){g.x2=this.imgW;g.x1=this.imgW-m}if(g.y2>this.imgH){g.y2=this.imgH;g.y1=this.imgH-l}}else{if(g.x1<0){g.x1=0}if(g.y1<0){g.y1=0}if(g.x2>this.imgW){g.x2=this.imgW}if(g.y2>this.imgH){g.y2=this.imgH}if(typeof(d)!="undefined"){if(this.ratioX>0){this.applyRatio(g,{x:this.ratioX,y:this.ratioY},d,c)}else{if(a){this.applyRatio(g,{x:1,y:1},d,c)}}var k={a1:g.x1,a2:g.x2};var j={a1:g.y1,a2:g.y2};var i=this.options.minWidth;var h=this.options.minHeight;if((i==0||h==0)&&a){if(i>0){h=i}else{if(h>0){i=h}}}this.applyMinDimension(k,i,d.x,{min:0,max:this.imgW});this.applyMinDimension(j,h,d.y,{min:0,max:this.imgH});g={x1:k.a1,y1:j.a1,x2:k.a2,y2:j.a2}}}this.areaCoords=g},applyMinDimension:function(d,c,b,a){if((d.a2-d.a1)<c){if(b==1){d.a2=d.a1+c}else{d.a1=d.a2-c}if(d.a1<a.min){d.a1=a.min;d.a2=c}else{if(d.a2>a.max){d.a1=a.max-c;d.a2=a.max}}}},applyRatio:function(e,c,d,b){var a;if(b=="N"||b=="S"){a=this.applyRatioToAxis({a1:e.y1,b1:e.x1,a2:e.y2,b2:e.x2},{a:c.y,b:c.x},{a:d.y,b:d.x},{min:0,max:this.imgW});e.x1=a.b1;e.y1=a.a1;e.x2=a.b2;e.y2=a.a2}else{a=this.applyRatioToAxis({a1:e.x1,b1:e.y1,a2:e.x2,b2:e.y2},{a:c.x,b:c.y},{a:d.x,b:d.y},{min:0,max:this.imgH});e.x1=a.a1;e.y1=a.b1;e.x2=a.a2;e.y2=a.b2}},applyRatioToAxis:function(j,g,f,d){var b=Object.extend(j,{});var a=b.a2-b.a1;var i=Math.floor(a*g.b/g.a);var h;var e;var c=null;if(f.b==1){h=b.b1+i;if(h>d.max){h=d.max;c=h-b.b1}b.b2=h}else{h=b.b2-i;if(h<d.min){h=d.min;c=h+b.b2}b.b1=h}if(c!=null){e=Math.floor(c*g.a/g.b);if(f.a==1){b.a2=b.a1+e}else{b.a1=b.a1=b.a2-e}}return b},drawArea:function(){if(!this.isIE){Element.show($(this.overlay))}var j=this.calcW();var i=this.calcH();var h=this.areaCoords.x2;var g=this.areaCoords.y2;var f=this.selArea.style;f.left=this.areaCoords.x1+"px";f.top=this.areaCoords.y1+"px";f.width=j+"px";f.height=i+"px";var e=Math.ceil((j-6)/2)+"px";var d=Math.ceil((i-6)/2)+"px";this.handleN.style.left=e;this.handleE.style.top=d;this.handleS.style.left=e;this.handleW.style.top=d;if(this.isIE){this.north.style.height=this.areaCoords.y1+"px";var c=this.east.style;c.top=this.areaCoords.y1+"px";c.height=i+"px";c.left=h+"px";c.width=(this.img.width-h)+"px";var b=this.south.style;b.top=g+"px";b.height=(this.img.height-g)+"px";var a=this.west.style;a.top=this.areaCoords.y1+"px";a.height=i+"px";a.width=this.areaCoords.x1+"px"}else{f.backgroundPosition="-"+this.areaCoords.x1+"px -"+this.areaCoords.y1+"px"}this.subDrawArea();this.forceReRender()},forceReRender:function(){if(this.isIE||this.isWebKit){var g=document.createTextNode(" ");var e,c,f,b;if(this.isIE){fixEl=this.selArea}else{if(this.isWebKit){fixEl=document.getElementsByClassName("imgCrop_marqueeSouth",this.imgWrap)[0];e=Builder.node("div","");e.style.visibility="hidden";var a=["SE","S","SW"];for(b=0;b<a.length;b++){c=document.getElementsByClassName("imgCrop_handle"+a[b],this.selArea)[0];if(c.childNodes.length){c.removeChild(c.childNodes[0])}c.appendChild(e)}}}fixEl.appendChild(g);fixEl.removeChild(g)}},startResize:function(a){this.startCoords=this.cloneCoords(this.areaCoords);this.resizing=true;this.resizeHandle=Element.classNames(Event.element(a)).toString().replace(/([^N|NE|E|SE|S|SW|W|NW])+/,"");Event.stop(a)},startDrag:function(a){Element.show(this.selArea);this.clickCoords=this.getCurPos(a);this.setAreaCoords({x1:this.clickCoords.x,y1:this.clickCoords.y,x2:this.clickCoords.x,y2:this.clickCoords.y});this.dragging=true;this.onDrag(a);Event.stop(a)},getCurPos:function(a){return curPos={x:Event.pointerX(a)-this.wrapOffsets.left,y:Event.pointerY(a)-this.wrapOffsets.top}},onDrag:function(f){var c=null;if(this.dragging||this.resizing){var d=this.getCurPos(f);var b=this.cloneCoords(this.areaCoords);var a={x:1,y:1}}if(this.dragging){if(d.x<this.clickCoords.x){a.x=-1}if(d.y<this.clickCoords.y){a.y=-1}this.transformCoords(d.x,this.clickCoords.x,b,"x");this.transformCoords(d.y,this.clickCoords.y,b,"y")}else{if(this.resizing){c=this.resizeHandle;if(c.match(/E/)){this.transformCoords(d.x,this.startCoords.x1,b,"x");if(d.x<this.startCoords.x1){a.x=-1}}else{if(c.match(/W/)){this.transformCoords(d.x,this.startCoords.x2,b,"x");if(d.x<this.startCoords.x2){a.x=-1}}}if(c.match(/N/)){this.transformCoords(d.y,this.startCoords.y2,b,"y");if(d.y<this.startCoords.y2){a.y=-1}}else{if(c.match(/S/)){this.transformCoords(d.y,this.startCoords.y1,b,"y");if(d.y<this.startCoords.y1){a.y=-1}}}}}if(this.dragging||this.resizing){this.setAreaCoords(b,false,f.shiftKey,a,c);this.drawArea();Event.stop(f)}},transformCoords:function(e,d,c,b){var a=new Array();if(e<d){a[0]=e;a[1]=d}else{a[0]=d;a[1]=e}if(b=="x"){c.x1=a[0];c.x2=a[1]}else{c.y1=a[0];c.y2=a[1]}},endCrop:function(){this.dragging=false;this.resizing=false;this.options.onEndCrop(this.areaCoords,{width:this.calcW(),height:this.calcH()})},subInitialize:function(){},subDrawArea:function(){}};Cropper.ImgWithPreview=Class.create();Object.extend(Object.extend(Cropper.ImgWithPreview.prototype,Cropper.Img.prototype),{subInitialize:function(){this.hasPreviewImg=false;if(typeof(this.options.previewWrap)!="undefined"&&this.options.minWidth>0&&this.options.minHeight>0){this.previewWrap=$(this.options.previewWrap);this.previewImg=this.img.cloneNode(false);this.options.displayOnInit=true;this.hasPreviewImg=true;Element.addClassName(this.previewWrap,"imgCrop_previewWrap");Element.setStyle(this.previewWrap,{width:this.options.minWidth+"px",height:this.options.minHeight+"px"});this.previewWrap.appendChild(this.previewImg)}},subDrawArea:function(){if(this.hasPreviewImg){var f=this.calcW();var d=this.calcH();var c={x:this.imgW/f,y:this.imgH/d};var b={x:f/this.options.minWidth,y:d/this.options.minHeight};var a={w:Math.ceil(this.options.minWidth*c.x)+"px",h:Math.ceil(this.options.minHeight*c.y)+"px",x:"-"+Math.ceil(this.areaCoords.x1/b.x)+"px",y:"-"+Math.ceil(this.areaCoords.y1/b.y)+"px"};var e=this.previewImg.style;e.width=a.w;e.height=a.h;e.left=a.x;e.top=a.y}}});